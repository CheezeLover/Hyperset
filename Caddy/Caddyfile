{
    order authenticate before respond
    order authorize before basicauth

    security {
        local identity store localdb {
            realm local
            path /data/users.json
        }

        authentication portal myportal {
            crypto key sign-verify {env.AUTH_CRYPTO_KEY}
            enable identity store localdb
            cookie domain cluster.internal
            ui {
                links {
                    "Portal" https://{$HYPERSET_DOMAIN}
                    "OpenWebUI" https://openwebui.{$HYPERSET_DOMAIN}
                }
            }
        }

        authorization policy mypolicy {
            set auth url https://auth.{$HYPERSET_DOMAIN}/
            set token sources cookie header
            validate bearer header
            crypto key sign-verify {env.AUTH_CRYPTO_KEY}
            allow roles authp/admin authp/user
        }
    }
}

auth.{$HYPERSET_DOMAIN} {
    tls internal {
        on_demand
    }
    authenticate with myportal
}

{$HYPERSET_DOMAIN} {
    tls internal {
        on_demand
    }
    authorize with mypolicy
    handle {
        root * /Portal
        file_server
    }
}

openwebui.{$HYPERSET_DOMAIN} {
    tls internal {
        on_demand
    }
    authorize with mypolicy
    reverse_proxy hyperset-open-webui:8080
}