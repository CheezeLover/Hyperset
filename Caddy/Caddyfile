{
    order authenticate before respond
    order authorize before basicauth

    security {
        local identity store localdb {
            realm local
            path /data/users.json
        }

        authentication portal myportal {
            crypto default token lifetime 86400
            crypto key sign-verify {env.AUTH_CRYPTO_KEY}
            enable identity store localdb
            cookie domain cluster.internal
            cookie samesite lax
            cookie insecure off

            # --- SWAP THIS BLOCK WHEN CHANGING PROVIDERS ---
            transform user {
                match realm local
                match role authp/admin
                action add role hyperset/admin
            }
            transform user {
                match realm local
                match role authp/user
                action add role hyperset/user
            }
            # --- END SWAP BLOCK ---

            ui {
                links {
                    "Portal" https://{$HYPERSET_DOMAIN}
                    "OpenWebUI" https://openwebui.{$HYPERSET_DOMAIN}
                    "Superset" https://superset.{$HYPERSET_DOMAIN}
                    "Pages" https://pages.{$HYPERSET_DOMAIN}
                }
            }
        }

        authorization policy mypolicy {
            set auth url https://auth.{$HYPERSET_DOMAIN}/
            set token sources cookie header
            validate bearer header
            crypto key sign-verify {env.AUTH_CRYPTO_KEY}
            allow roles hyperset/admin hyperset/user
            inject headers with claims
        }
    }
}

auth.{$HYPERSET_DOMAIN} {
    tls internal {
        on_demand
    }
    authenticate with myportal
}

{$HYPERSET_DOMAIN} {
    tls internal {
        on_demand
    }
    authorize with mypolicy

    # Serve a dynamic config.js with env vars injected â€” loaded by the portal on startup
    handle /config.js {
        header Content-Type "application/javascript"
        respond `window.HYPERSET_CONFIG = {
  supersetUrl: "https://superset.{env.HYPERSET_DOMAIN}"
};`
    }

    handle {
        root * /Portal
        file_server
    }
}

openwebui.{$HYPERSET_DOMAIN} {
    tls internal {
        on_demand
    }
    authorize with mypolicy
    reverse_proxy hyperset-open-webui:8080 {
        header_up X-Auth-Request-User {http.request.header.X-Token-User-Id}
        header_up X-Auth-Request-Email {http.request.header.X-Token-User-Email}
        header_up X-Auth-Request-Groups {http.request.header.X-Token-User-Roles}
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
}

pages.{$HYPERSET_DOMAIN} {
    tls internal {
        on_demand
    }
    authorize with mypolicy
    reverse_proxy hyperset-pages:8000 {
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
}

superset.{$HYPERSET_DOMAIN} {
    tls internal {
        on_demand
    }
    authorize with mypolicy
    reverse_proxy {env.SUPERSET_UPSTREAM} {
        header_up X-Webauth-User {http.request.header.X-Token-User-Id}
        header_up X-Webauth-Email {http.request.header.X-Token-User-Email}
        header_up X-Webauth-Groups {http.request.header.X-Token-User-Roles}
        header_down -X-Frame-Options
        header_down -Content-Security-Policy
    }
}